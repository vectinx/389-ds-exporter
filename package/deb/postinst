#!/bin/bash
set -e

USER="ds-exporter"
GROUP="ds-exporter"
LOGDIR="/var/log/389-ds-exporter"
CONFIG="/etc/389-ds-exporter/config.yml"

echo "Post-install script running..."

if ! id -u "$USER" > /dev/null 2>&1; then
    echo "Creating system user $USER..."
    useradd --system --no-create-home --shell /usr/sbin/nologin "$USER"
else
    echo "User $USER already exists, skipping creation."
fi

if [ ! -d "$LOGDIR" ]; then
    echo "Creating log directory $LOGDIR..."
    mkdir -p "$LOGDIR"
    chown "$USER:$GROUP" "$LOGDIR"
    chmod 755 "$LOGDIR"
else
    echo "Log directory $LOGDIR already exists, set permissions."
    chown "$USER:$GROUP" "$LOGDIR"
    chmod 755 "$LOGDIR"
fi

if [ -f "$CONFIG" ]; then
    echo "Set config file owner"
    chown "$USER:$GROUP" "$CONFIG"
fi

if command -v systemctl >/dev/null 2>&1; then
    echo "Reloading systemd daemon..."
    systemctl daemon-reload || echo "Warning: systemctl daemon-reload failed"
else
    echo "systemctl not found, skipping daemon-reload"
fi

echo "Post-install script finished successfully."

exit 0
